<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Anonim Sohbet</title>
<style>
  body {
    background-color: #121212;
    color: #eee;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column;
  }
  #chat {
    flex-grow: 1;
    overflow-y: auto;
    padding: 10px;
    border-bottom: 2px solid #0f0;
  }
  #chat p {
    margin: 5px 0;
  }
  #chat p span.nickname {
    font-weight: bold;
    color: #0f0;
  }
  #messageInput {
    background-color: #222;
    border: none;
    color: #eee;
    font-size: 16px;
    padding: 15px;
    width: 100%;
    box-sizing: border-box;
    outline: none;
  }
</style>
<script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
</head>
<body>

<div id="chat"></div>
<input id="messageInput" type="text" autocomplete="off" placeholder="Mesaj yaz ve Enter ile gönder..." autofocus />

<script>
  const socket = io();
  const chatDiv = document.getElementById('chat');
  const input = document.getElementById('messageInput');
  const nickname = "{{ nickname|e }}";

  // Mesajları göstermek için
  function addMessage(nick, text) {
    const p = document.createElement('p');
    p.innerHTML = '<span class="nickname">' + nick + ':</span> ' + text;
    chatDiv.appendChild(p);
    chatDiv.scrollTop = chatDiv.scrollHeight;
  }

  // Önceden gelen mesajları yükle
  const messages = {{ messages|tojson }};
  messages.forEach(m => addMessage(m.nickname, m.text));

  // Mesaj geldiğinde
  socket.on('receive_message', data => {
    addMessage(data.nickname, data.text);
  });

  // Sohbet temizlendiğinde
  socket.on('chat_cleared', () => {
    chatDiv.innerHTML = '';
  });

  // Exit komutu ile sohbetten çıkış
  socket.on('exit_chat', () => {
    alert('Sohbetten çıktınız.');
    window.location.href = "/";
  });

  // Mesaj gönder
  input.addEventListener('keydown', e => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      const text = input.value.trim();
      if (text) {
        socket.emit('send_message', { nickname: nickname, text: text });
        input.value = '';
      }
    }
  });
</script>

</body>
</html>

